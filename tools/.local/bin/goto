#!/usr/bin/env python3

import sys
from pathlib import Path
from subprocess import run, CalledProcessError

SEARCH_ROOT = Path("~/dev").expanduser()

def main():
	repos = find_repos()
	repos_str = '\n'.join(str(s) for s in repos)

	fzf_opts = [
		"--height=~50%",
		"--min-height=5",
		"--header='CTRL-c or ESC to quit'",
	]
	exec(f"echo '{repos_str}' | fzf", shell=True, capture_output=False)

def find_repos() -> list[Path]:
	_, paths = exec(f"find { SEARCH_ROOT } -type d -name .git -prune -print 2>/dev/null", shell=True, check=False)

	# return the containing directory, oit the `.git` one
	return [Path(p).parent for p in paths.split("\n")]

def exec(command: str | list[str], *, check: bool = True, capture_output:bool=True, shell: bool = False, **kwargs) -> tuple[int, str]:
    if isinstance(command, str) and not shell:
    	command = command.split(' ')

    try:
        ret = run(
            command, text=True, capture_output=capture_output, check=check, shell=shell, **kwargs
        )
        return ret.returncode, ret.stdout.strip()
    except CalledProcessError as ex:
        print(
            f"Call to {ex.cmd} failed. Returned {ex.returncode}. Standard Error was: '{ex.stderr}'"
        )
        raise SystemExit(1)

if __name__ == "__main__":
	main()